"""
Utility script to translate all articles and reference summaries in dataset.py to Slovak
using the Gemini 2.5 Pro model.

Default behavior: overwrite dataset.py with translated content (after optional backup).

Usage examples:
    # Overwrite dataset.py in place (creates backup by default)
    GOOGLE_API_KEY=... python3 translate_dataset.py

    # Overwrite dataset.py without backup
    GOOGLE_API_KEY=... python3 translate_dataset.py --no-backup

    # Write to a custom file instead of dataset.py
    GOOGLE_API_KEY=... python3 translate_dataset.py --output path/to/dataset_sk.py

Notes:
- Keeps ids/topics intact; only translates "article" and "reference_summary".
- Writes UTF-8 Python with the same variable name (GOLD_STANDARD_DATASET).
"""

import argparse
import json
import os
import sys
import time
from typing import Any, Dict, List, Optional

import google.generativeai as genai

from dataset import GOLD_STANDARD_DATASET


DEFAULT_MODEL = "gemini-2.5-flash"
DEFAULT_OUTPUT = os.path.join(
    os.path.dirname(__file__),
    "dataset.py",
)


def translate_text(text: str, model) -> str:
    """Translate text to Slovak using Gemini; retries on transient errors."""
    prompt = (
        "Prelož nasledujúci text z angličtiny do slovenčiny. Zachovaj fakty, mená, čísla, citácie "
        "a formát odsekov; nevynechávaj ani nepridávaj obsah. Vráť len preklad, bez úvodu či komentára.\n\n"
        f"Text:\n{text}"
    )
    for attempt in range(3):
        try:
            resp = model.generate_content(prompt)
            translated = (resp.text or "").strip()
            if translated:
                return translated
        except Exception as exc:  # pragma: no cover - best-effort retry
            print(f"Translate attempt {attempt + 1} failed: {exc}", file=sys.stderr)
            time.sleep(2 + attempt)
    raise RuntimeError("Translation failed after retries.")


def translate_entry(entry: Dict[str, Any], model) -> Dict[str, Any]:
    """Return a copy of the entry with Slovak article and reference_summary."""
    out = dict(entry)
    out["article"] = translate_text(entry["article"], model)
    out["reference_summary"] = translate_text(entry["reference_summary"], model)
    return out


def write_output(data: List[Dict[str, Any]], output_path: str) -> None:
    """Write translated dataset to a Python file."""
    header = (
        "# Auto-generated by translate_dataset.py using Gemini 2.5 Pro.\n"
        "GOLD_STANDARD_DATASET = "
    )
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(header)
        json.dump(data, f, ensure_ascii=False, indent=2)
        f.write("\n")


def main() -> None:
    parser = argparse.ArgumentParser(description="Translate dataset.py entries to Slovak.")
    parser.add_argument(
        "--output",
        default=DEFAULT_OUTPUT,
        help=f"Path to write translated dataset (default: {DEFAULT_OUTPUT})",
    )
    parser.add_argument(
        "--no-backup",
        action="store_true",
        help="Do not create a .bak backup when overwriting dataset.py",
    )
    parser.add_argument(
        "--model",
        default=DEFAULT_MODEL,
        help=f"Gemini model to use (default: {DEFAULT_MODEL})",
    )
    args = parser.parse_args()

    api_key = os.getenv("GOOGLE_API_KEY")
    if not api_key:
        print("GOOGLE_API_KEY is not set.", file=sys.stderr)
        sys.exit(1)

    genai.configure(api_key=api_key)
    model = genai.GenerativeModel(args.model)

    translated: List[Dict[str, Any]] = []
    total = len(GOLD_STANDARD_DATASET)
    for idx, entry in enumerate(GOLD_STANDARD_DATASET, start=1):
        print(f"[{idx}/{total}] Translating {entry.get('id')} ...", file=sys.stderr)
        translated.append(translate_entry(entry, model))
        time.sleep(0.2)  # small pause to be gentle with the API

    output_path = args.output
    if not args.no_backup and os.path.abspath(output_path) == os.path.abspath(DEFAULT_OUTPUT):
        backup_path = f"{output_path}.bak"
        try:
            os.replace(output_path, backup_path)
            print(f"Backup created at {backup_path}", file=sys.stderr)
        except FileNotFoundError:
            # No original file to back up
            pass

    write_output(translated, output_path)
    print(f"Done. Translated dataset written to {output_path}")


if __name__ == "__main__":
    main()
